# 智能出题系统 - 系统架构文档

## 1. 系统概述

本系统是一个基于 LangGraph 的多智能体协同出题系统，采用"照猫画虎"（Few-Shot Learning）策略，通过分析知识点和母题库，自动生成高质量的考试题目。

## 2. 核心架构

### 2.1 技术栈

```
前端展示层: Streamlit
智能体编排: LangGraph
LLM 接口: Google Gemini / OpenAI (可配置)
数据处理: Pandas, Scikit-learn (TF-IDF)
知识检索: 自定义向量化 + 知识点映射
计算工具: 自定义房地产计算器
```

### 2.2 系统分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户交互层 (Streamlit UI)                  │
│  - API 配置                                                   │
│  - 章节选择 (支持多选/全选/仅计算类)                          │
│  - 出题设置 (数量/难度/题型/出题模式) ✅                        │
│  - 实时生成状态展示                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  应用编排层 (app.py)                          │
│  - 初始化 KnowledgeRetriever                                 │
│  - 构建 LangGraph inputs                                     │
│  - 流式事件处理与 UI 渲染                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              知识检索层 (exam_factory.py)                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ KnowledgeRetriever                                   │   │
│  │  - 知识库加载 (bot_knowledge_base.jsonl)             │   │
│  │  - 母题库加载 (存量房买卖母卷ABCD.xls)               │   │
│  │  - TF-IDF 向量化                                     │   │
│  │  - 知识点映射 (question_knowledge_mapping.json)      │   │
│  │  - 题型过滤 (单选/多选/判断)                         │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│           多智能体协同层 (exam_graph.py)                       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ LangGraph Workflow                                  │    │
│  │                                                      │    │
│  │  ┌──────────┐     ┌──────────────┐                 │    │
│  │  │  Router  │ ──→ │ Specialist   │ (法律/综合)     │    │
│  │  │  路由器  │     │  专家节点    │                 │    │
│  │  └──────────┘     └──────────────┘                 │    │
│  │       │                    ↓                         │    │
│  │       │           ┌──────────────┐                  │    │
│  │       └─────────→ │   Finance    │ (金融+计算)     │    │
│  │                   │   专家节点   │                  │    │
│  │                   └──────────────┘                  │    │
│  │                           ↓                          │    │
│  │                   ┌──────────────┐                  │    │
│  │                   │    Writer    │ (格式化)        │    │
│  │                   │   写作节点   │                  │    │
│  │                   └──────────────┘                  │    │
│  │                           ↓                          │    │
│  │                   ┌──────────────┐                  │    │
│  │                   │    Critic    │ (质检)          │    │
│  │                   │   评审节点   │ ✅              │    │
│  │                   └──────────────┘                  │    │
│  │                      ↓    ↓    ↓   ↓                 │    │
│  │                   通过  轻微  严重  超限             │    │
│  │                    END  │     │    END              │    │
│  │                         ↓     ↓                      │    │
│  │                    ┌─────┐  Router                  │    │
│  │                    │Fixer│   (重路由) ✅            │    │
│  │                    └─────┘                           │    │
│  │                       ↓                               │    │
│  │                    Critic (重新验证) ✅              │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              工具层 (calculation_logic.py)                    │
│  - 房地产计算工具集 (16+ 计算函数)                            │
│  - 贷款、税费、面积、容积率等计算                             │
└─────────────────────────────────────────────────────────────┘
```

## 3. 数据流架构

### 3.1 输入数据流

```
用户选择章节 + 题型 + 数量
        ↓
从知识库随机抽取知识点切片
        ↓
构建 AgentState 初始状态
        ↓
传递给 LangGraph
```

### 3.2 LangGraph 内部数据流

```
AgentState (初始)
  ├── kb_chunk: 知识点切片
  ├── examples: [] (空，待填充)
  ├── retry_count: 0
  └── logs: []
        ↓
Router Node
  ├── 分析知识点内容
  ├── 计算金融/法律相关度
  ├── 提取掌握程度
  └── 决定 agent_name (FinanceAgent/LegalAgent/GeneralAgent)
        ↓
Specialist/Finance Node
  ├── 获取 examples (照猫画虎) ← retriever + question_type
  ├── Finance: 决定是否需要计算器
  ├── Finance: 调用计算工具 (如需要)
  └── 生成初稿 (draft)
        ↓
Writer Node
  └── 格式化输出 (标准 JSON)
        ↓
Critic Node ✅
  ├── 验证答案正确性
  ├── 验证解析逻辑性
  ├── (Finance) 调用计算器复核
  ├── 问题分类: major (答案错误) / minor (解析问题)
  └── 智能决策 (critical_decision):
      ├── 通过 → END
      ├── 轻微问题 → Fixer
      ├── 严重问题 → Router (重新路由) ✅
      └── retry ≥ 3 → 自愈输出
        ↓
Fixer Node (如需要) ✅
  ├── 分析问题
  ├── 修复题目
  └── 回到 Critic 重新验证 ✅ (形成循环)
        ↓
最终输出: ExamQuestion (JSON)
```

## 4. 核心设计模式

### 4.1 照猫画虎 (Few-Shot Learning)

**时机**: 在路由后、生成前
**方法**: 
1. 知识点精准匹配 (基于 question_knowledge_mapping.json)
2. 题型过滤 (单选/多选/判断)
3. 数据质量过滤 (去除 NaN)

**效果**: 生成的题目风格与母题库一致

### 4.2 反馈循环机制 ✅ (新增)

**循环类型**:
1. **Fixer → Critic 循环** (轻微问题)
   - 触发条件: 解析不清、格式问题
   - 循环路径: Critic (发现问题) → Fixer (修复) → Critic (重新验证)
   - 最大次数: 3次 (retry_count)

2. **Critic → Router 循环** (严重问题)
   - 触发条件: 答案错误
   - 循环路径: Critic (答案错误) → Router (重新路由) → 新Agent (重新生成) → Writer → Critic
   - 特点: 可能选择不同的专家Agent

**状态管理**:
- Router检测到retry_count > 0时清理旧状态 (draft, final_json)
- 每次循环增加retry_count计数器
- 超过3次自动触发自愈输出

### 4.3 自愈机制

**触发条件**:
- JSON 解析失败
- Critic 验证失败 (retry_count ≥ 3)
- 工具调用异常

**处理策略** ✅:
1. retry_count < 3: Fixer 尝试修复 → 回到 Critic 验证
2. retry_count ≥ 3: 自愈输出 (避免无限循环)
3. 严重问题: 触发 Router 重新路由

### 4.4 计算器智能调用 ✅ (增强)

**决策依据**:
1. 母题范例是否包含计算题
2. 知识点材料是否包含数值
3. LLM 判断是否需要计算

**计算步骤分析** ✅:
- **理解计算步骤**：计算器可能只是解决整个问题的一个步骤
- **参数提取规则**：必须从题目/材料中提取具体数值（不能是描述性文字）
- **多步计算支持**：如果题目问的是最终结果，可能需要多步计算
  - 第一步：使用计算器计算中间结果（如：房龄）
  - 第二步：基于第一步结果进一步计算（如：贷款年限 = 50 - 房龄）
  - 第三步：考虑其他因素（如：借款人年龄），取最小值

**计算流程**:
1. Finance Node: 
   - LLM 分析计算步骤
   - 选择工具 + 提取参数（必须是数字）
   - 调用 RealEstateCalculator
2. Critic Node: 
   - 从题目中提取参数（必须是数字）
   - 重新调用验证结果
   - 如果计算器结果是中间步骤，验证完整计算过程 ✅

## 5. 关键模块说明

### 5.1 KnowledgeRetriever
- **职责**: 知识检索、母题匹配
- **核心方法**:
  - `get_examples_by_knowledge_point()`: 基于知识点精准检索
  - `_is_valid_example()`: 数据质量过滤
  - `_get_question_type()`: 题型识别
  - `_matches_question_type()`: 题型匹配

### 5.2 LangGraph Nodes
- **Router**: 知识点分析 + 路由决策 + 重路由状态清理 ✅
- **Specialist**: 法律/综合类题目生成
- **Finance**: 金融/计算类题目生成 (带计算器)
- **Writer**: 格式标准化
- **Critic**: 质量验证 (答案 + 解析) + 问题分类 (major/minor) ✅
- **Fixer**: 错误修复 + 循环回到Critic ✅
- **critical_decision**: 智能决策函数 (pass/fix/reroute/self_heal) ✅

### 5.3 RealEstateCalculator
- 16+ 房地产专业计算函数
- 覆盖贷款、税费、面积、容积率等

## 6. 配置管理

### 6.1 API 配置
- 支持 OpenAI / Google Gemini
- 可配置 Base URL
- 支持代理设置

### 6.2 知识库配置
- `bot_knowledge_base.jsonl`: 1712 条知识点
- `存量房买卖母卷ABCD.xls`: 408 道母题
- `question_knowledge_mapping.json`: 母题→知识点映射 (408→200 路径)

## 7. 性能优化

### 7.1 缓存机制
- Streamlit `@st.cache_resource`: KnowledgeRetriever 单例

### 7.2 检索优化
- 候选扩大策略: k×5 候选 → 过滤 → k 结果
- TF-IDF 预计算

### 7.3 并发控制
- LangGraph 流式输出
- 异步事件处理

## 8. 扩展性设计

### 8.1 模块化
- 检索层、智能体层、工具层解耦
- 易于替换 LLM 后端

### 8.2 可配置
- 智能体数量可扩展
- 计算工具可插拔

### 8.3 可观测
- 完整日志记录
- UI 实时展示每个节点的执行状态
