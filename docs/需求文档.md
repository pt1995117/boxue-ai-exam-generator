# 智能出题系统 - 需求文档

## 1. 项目背景

### 1.1 业务场景
为房地产经纪人培训考试系统提供自动化出题能力，替代人工出题，提高出题效率和质量一致性。

### 1.2 核心挑战
1. **知识点覆盖广**：涉及法律、金融、房产交易等多领域
2. **计算题复杂**：包含贷款、税费等专业计算
3. **质量要求高**：题目需准确、干扰项需合理、解析需清晰
4. **风格要求统一**：需与现有题库风格保持一致

## 2. 功能需求

### 2.1 核心功能

#### F1: 智能出题
- **FR1.1**: 支持从知识库选择章节生成题目
- **FR1.2**: 支持批量生成 (1-100 题)
- **FR1.3**: 支持题型选择 (单选题/多选题/判断题)
- **FR1.4**: 支持难度偏好设置
- **FR1.5**: 支持出题模式选择（灵活/严谨）✅
  - 灵活模式：场景化、灵活表达，适合日常练习
  - 严谨模式：严格按照知识点输出，适合标准化考试
- **FR1.6**: 生成内容包含：题干、选项、答案、解析

#### F2: 照猫画虎 (Few-Shot Learning)
- **FR2.1**: 根据知识点自动匹配历史相似题目
- **FR2.2**: 根据题型过滤母题 (单选配单选、判断配判断)
- **FR2.3**: 参考母题风格生成新题
- **FR2.4**: UI 展示参考的母题范例 (题干、选项、答案、解析)

#### F3: 多智能体协同
- **FR3.1**: Router 自动识别知识点类型，派发给合适的专家
  - 金融类 → FinanceAgent
  - 法律类 → LegalAgent
  - 综合类 → GeneralAgent
- **FR3.2**: 专家节点生成初稿
- **FR3.3**: Writer 节点标准化格式
- **FR3.4**: Critic 节点质量验证
- **FR3.5**: Fixer 节点错误修复

#### F4: 计算器集成 (金融题) ✅ (增强)
- **FR4.1**: 自动判断是否需要计算
- **FR4.2**: 支持 16+ 房地产计算函数
  - 房龄计算支持两种模式：通用房龄和贷款用房龄 ✅
  - 增值税税率：5.3%（与原文一致）✅
  - 参数类型验证：自动处理字符串参数 ✅
- **FR4.3**: 计算结果嵌入题目
- **FR4.4**: Critic 重新计算验证答案
- **FR4.5**: 计算步骤分析 ✅
  - 理解计算器可能只是解决一个步骤
  - 支持多步计算验证
  - 参数提取规则：必须提取具体数值

#### F5: 质量保障 ✅
- **FR5.1**: 答案正确性验证
- **FR5.2**: 解析逻辑性验证
- **FR5.3**: 计算结果验证 (如适用)
- **FR5.4**: 问题分类: 严重问题 (major) / 轻微问题 (minor) ✅
- **FR5.5**: 智能决策机制 (critical_decision) ✅:
  - 通过 → 结束
  - 轻微问题 → Fixer 修复
  - 严重问题 → Router 重新路由
  - 超限 (retry≥3) → 自愈输出
- **FR5.6**: 数据质量过滤 (去除 NaN 母题)

#### F6: 反馈循环机制 ✅ (新增)
- **FR6.1**: Fixer → Critic 循环: 修复后自动回到验证
- **FR6.2**: Critic → Router 重路由: 严重问题触发重新路由
- **FR6.3**: 状态清理: Router 检测重路由并清理旧状态
- **FR6.4**: retry_count 管理: 最多3次重试，避免无限循环

### 2.2 用户交互需求

#### F7: UI 配置
- **FR6.1**: 支持 API 配置 (OpenAI / Gemini)
- **FR6.2**: 支持代理设置
- **FR6.3**: 支持章节多选/全选/仅计算类
- **FR6.4**: 支持出题参数设置

#### F8: 过程可视化 ✅
- **FR7.1**: 实时展示生成进度
- **FR7.2**: 展示 Router 决策过程 (知识点、相关度、派发专家)
- **FR7.3**: 展示照猫画虎的母题范例
- **FR7.4**: 展示计算器调用详情 (函数、参数、结果)
- **FR7.5**: 展示初稿内容
- **FR7.6**: 展示 Critic 评审过程
- **FR8.7**: 展示 Fixer 修复过程 (如发生)
- **FR8.8**: 展示最终生成的题目
- **FR8.9**: 展示重路由过程 (如发生) ✅

#### F9: 结果导出
- **FR9.1**: 题目展示 (题干、选项、答案、解析)
- **FR9.2**: 支持复制功能

## 3. 非功能需求

### 3.1 性能需求
- **NFR1.1**: 单题生成时间 < 30 秒 (取决于 LLM 响应速度)
- **NFR1.2**: 知识库加载时间 < 5 秒
- **NFR1.3**: 支持流式输出，提升用户体验

### 3.2 可靠性需求
- **NFR2.1**: LLM 调用失败自动重试
- **NFR2.2**: JSON 解析失败自动修复
- **NFR2.3**: 质量验证失败自动重试 (最多 2 次)

### 3.3 可用性需求
- **NFR3.1**: UI 界面友好，操作简单
- **NFR3.2**: 错误提示清晰
- **NFR3.3**: 生成过程透明可观测

### 3.4 可维护性需求
- **NFR4.1**: 代码模块化，职责清晰
- **NFR4.2**: 配置与代码分离
- **NFR4.3**: 日志完整，便于调试

### 3.5 可扩展性需求
- **NFR5.1**: 支持添加新的智能体
- **NFR5.2**: 支持添加新的计算工具
- **NFR5.3**: 支持切换 LLM 后端

## 4. 数据需求

### 4.1 输入数据
- **知识库**: `bot_knowledge_base.jsonl` (1712 条)
  - 字段: 完整路径、掌握程度、核心内容
- **母题库**: `存量房买卖母卷ABCD.xls` (408 道)
  - 字段: 题干、选项1-5、正确答案、解析、考点、难度值
- **知识点映射**: `question_knowledge_mapping.json`
  - 408 道母题 → 200 个知识点路径的映射

### 4.2 输出数据
- **标准题目格式**:
  ```json
  {
    "question": "题干",
    "options": ["A. 选项1", "B. 选项2", "C. 选项3", "D. 选项4"],
    "answer": "A",
    "explanation": "解析"
  }
  ```

## 5. 约束条件

### 5.1 技术约束
- **C1**: 必须使用 Streamlit 作为 UI 框架
- **C2**: 必须使用 LangGraph 进行智能体编排
- **C3**: LLM 需支持 JSON 格式输出

### 5.2 业务约束
- **C4**: 题目内容必须 100% 准确，不得出现幻觉
- **C5**: 题干中禁止出现"根据材料"等提示语
- **C6**: 干扰项必须似是而非，不能一眼假

### 5.3 数据约束
- **C7**: 知识库和母题库为静态数据，不可修改
- **C8**: 母题数据可能存在 NaN，需过滤

## 6. 优先级划分

### P0 - 必须实现
- 智能出题核心功能 (F1)
- 多智能体协同 (F3)
- 质量保障 (F5)
- 反馈循环机制 (F6) ✅
- UI 配置 (F7)

### P1 - 重要
- 照猫画虎 (F2)
- 计算器集成 (F4)
- 过程可视化 (F8)

### P2 - 可选
- 结果导出增强 (F9)
- 性能优化

## 7. 验收标准

### 7.1 功能验收
1. ✅ 能够根据选择的章节生成题目
2. ✅ Router 正确识别知识点类型并派发
3. ✅ 金融题能正确调用计算器
4. ✅ 照猫画虎能匹配正确的母题
5. ✅ Critic 能验证答案和解析的正确性
6. ✅ Fixer 能修复错误并回到Critic重新验证
7. ✅ 严重问题能触发Router重新路由

### 7.2 质量验收
1. ✅ 题目准确性 ≥ 95%
2. ✅ 干扰项合理性 (人工抽检)
3. ✅ 解析清晰度 (人工抽检)
4. ✅ 风格一致性 (与母题对比)

### 7.3 性能验收
1. ✅ 知识库加载 < 5 秒
2. ✅ 单题生成 < 30 秒 (取决于 LLM)
3. ✅ 无阻塞，流式输出

## 8. 用户场景

### 场景 1: 生成单选题
1. 用户打开系统
2. 配置 API Key
3. 选择章节 "第一篇 > 第一章 > 第一节"
4. 选择题型 "单选题"
5. 设置数量 "5 题"
6. 点击"开始出题"
7. 系统展示：Router 决策 → 母题范例 → 生成过程 → 最终题目
8. 用户复制题目

### 场景 2: 生成计算题
1. 用户选择章节 "第二篇 (金融税费相关)"
2. 勾选"仅选中计算类章节"
3. 选择题型 "单选题"
4. 点击"开始出题"
5. 系统：
   - Router 识别为金融类 → FinanceAgent
   - 获取计算类母题范例
   - Finance 调用计算器
   - 展示计算详情
   - 生成包含计算的题目
6. Critic 用计算器验证答案
7. 输出最终题目

### 场景 3: 生成判断题
1. 用户选择章节
2. 选择题型 "判断题"
3. 点击"开始出题"
4. 系统：
   - 只检索判断题母题 (选项1=正确, 选项2=错误)
   - 生成只有"正确/错误"两个选项的题目
5. 输出判断题

## 9. 风险与应对

### 风险 1: LLM 生成不稳定
- **应对**: Critic 验证 + Fixer 修复 + 最多 2 次重试

### 风险 2: 母题数量不足
- **应对**: TF-IDF 回退策略

### 风险 3: 计算器调用失败
- **应对**: 错误捕获 + 日志记录 + 降级为概念题

### 风险 4: 数据质量问题
- **应对**: 数据验证 + NaN 过滤
